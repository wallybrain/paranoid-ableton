---
phase: 07-session-awareness
plan: 02
type: execute
wave: 2
depends_on: ["07-01"]
files_modified:
  - test/session.test.js
autonomous: true

must_haves:
  truths:
    - "buildTrackDetailSnapshot composes existing buildTrackSnapshot with routing, grouping, clips, and device data"
    - "buildSessionSnapshot aggregates transport + all track details into complete session state"
    - "buildSessionStats computes correct track type counts, clip counts, and device summary"
    - "Empty clip slots (empty string names) are excluded from clips array"
    - "session_snapshot handler returns JSON response via ensureConnected -> buildSessionSnapshot"
    - "session_stats handler returns JSON response via ensureConnected -> buildSessionStats"
    - "handle() returns null for non-session tool names"
  artifacts:
    - path: "test/session.test.js"
      provides: "Unit tests for session helpers and tool handlers"
      min_lines: 100
  key_links:
    - from: "test/session.test.js"
      to: "src/tools/helpers.js"
      via: "import buildSessionSnapshot, buildTrackDetailSnapshot, buildSessionStats"
      pattern: "import.*buildSessionSnapshot.*from.*helpers"
    - from: "test/session.test.js"
      to: "src/tools/session.js"
      via: "import { handle } from session"
      pattern: "import.*handle.*from.*session"
    - from: "test/session.test.js"
      to: "src/tools/shared.js"
      via: "import setOscClient, resetClient for mock injection"
      pattern: "import.*setOscClient.*from.*shared"
---

<objective>
Unit tests for the session domain module (session.js) and helper functions (buildTrackDetailSnapshot, buildSessionSnapshot, buildSessionStats).

Purpose: Verify that session aggregation correctly composes existing snapshot builders with new routing, grouping, clip-slot, and device data. Ensure empty slot detection works and statistics computation is correct.

Output: test/session.test.js with comprehensive mock-based tests following the device.test.js pattern.
</objective>

<execution_context>
@/home/user/.claude/agents/gsd-planner.md
@/home/user/.claude/get-shit-done/workflows/execute-plan.md
@/home/user/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/07-session-awareness/07-RESEARCH.md
@src/tools/helpers.js
@src/tools/session.js
@test/device.test.js
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create session.test.js with helper and handler tests</name>
  <files>test/session.test.js</files>
  <action>
Create `test/session.test.js` following the exact test pattern from `test/device.test.js`:

**Imports:**
```javascript
import { describe, it, beforeEach, afterEach } from 'node:test';
import assert from 'node:assert/strict';
import { setOscClient, resetClient } from '../src/tools/shared.js';
import { buildTrackDetailSnapshot, buildSessionSnapshot, buildSessionStats } from '../src/tools/helpers.js';
import { handle } from '../src/tools/session.js';
```

**Mock factory:** Use the same `createMockClient(responseMap)` pattern from device.test.js (address:args key format, fallback to address-only).

**Session mock factory:** Create a `sessionMocks()` function that returns a responseMap for a 2-track, 3-scene session:

Track counts:
- `/live/song/get/num_tracks`: [2]
- `/live/song/get/num_scenes`: [3]

Transport (7 queries):
- `/live/song/get/tempo`: [120]
- `/live/song/get/is_playing`: [0]
- `/live/song/get/current_song_time`: [0]
- `/live/song/get/metronome`: [1]
- `/live/song/get/signature_numerator`: [4]
- `/live/song/get/signature_denominator`: [4]
- `/live/song/get/session_record_status`: [0]

Track 0 (MIDI track "Bass" with 1 device):
- `/live/track/get/name:0`: ['Bass']
- `/live/track/get/volume:0`: [0.85]
- `/live/track/get/panning:0`: [0]
- `/live/track/get/mute:0`: [0]
- `/live/track/get/solo:0`: [0]
- `/live/track/get/arm:0`: [1]
- `/live/track/get/has_midi_input:0`: [1]
- `/live/track/get/has_audio_input:0`: [0]
- `/live/track/get/num_devices:0`: [1]
- `/live/track/get/input_routing_type:0`: [0, 'All Ins']
- `/live/track/get/output_routing_type:0`: [0, 'Master']
- `/live/track/get/is_foldable:0`: [0, 0]
- `/live/track/get/is_grouped:0`: [0, 0]
- `/live/track/get/clips/name:0`: [0, 'Bass A', '', 'Bass C']
- `/live/track/get/devices/name:0`: [0, 'Wavetable']
- `/live/track/get/devices/type:0`: [0, 2]

Track 1 (Audio track "Drums" with 2 devices):
- `/live/track/get/name:1`: ['Drums']
- `/live/track/get/volume:1`: [0.7]
- `/live/track/get/panning:1`: [0.5]
- `/live/track/get/mute:1`: [0]
- `/live/track/get/solo:1`: [0]
- `/live/track/get/arm:1`: [0]
- `/live/track/get/has_midi_input:1`: [0]
- `/live/track/get/has_audio_input:1`: [1]
- `/live/track/get/num_devices:1`: [2]
- `/live/track/get/input_routing_type:1`: [1, 'Ext. In']
- `/live/track/get/output_routing_type:1`: [1, 'Master']
- `/live/track/get/is_foldable:1`: [1, 0]
- `/live/track/get/is_grouped:1`: [1, 0]
- `/live/track/get/clips/name:1`: [1, '', 'Drums B', '']
- `/live/track/get/devices/name:1`: [1, 'Compressor', 'EQ Eight']
- `/live/track/get/devices/type:1`: [1, 1, 1]

**Test suites:**

1. `describe('buildTrackDetailSnapshot')`:
   - `it('returns track with routing, grouping, clips, and devices')` -- call buildTrackDetailSnapshot(client, 0, 3) with track 0 mocks. Assert:
     - base fields present (name: 'Bass', type: 'midi', device_count: 1)
     - input_routing: 'All Ins'
     - output_routing: 'Master'
     - is_group: false
     - is_grouped: false
     - clips length: 2 (only scenes 0 and 2 have clips, scene 1 is empty '')
     - clips[0]: { scene: 0, name: 'Bass A', has_clip: true }
     - clips[1]: { scene: 2, name: 'Bass C', has_clip: true }
     - devices length: 1
     - devices[0]: { index: 0, name: 'Wavetable', type: 'instrument' }

   - `it('excludes empty clip slots')` -- use track 1 mocks (1 populated slot out of 3). Assert clips.length === 1, clips[0].scene === 1, clips[0].name === 'Drums B'

   - `it('returns empty devices array when device_count is 0')` -- create mock with num_devices:0, no device bulk queries. Assert devices array is empty, no device query errors.

2. `describe('buildSessionSnapshot')`:
   - `it('returns complete session with transport and all tracks')` -- use full sessionMocks(). Assert:
     - transport.tempo === 120
     - transport.is_playing === false
     - track_count === 2
     - scene_count === 3
     - tracks.length === 2
     - tracks[0].name === 'Bass'
     - tracks[1].name === 'Drums'
     - tracks[0].clips.length === 2
     - tracks[1].clips.length === 1

3. `describe('buildSessionStats')`:
   - `it('returns correct track type counts and totals')` -- use sessionMocks(). Assert:
     - track_counts.total === 2
     - track_counts.midi === 1
     - track_counts.audio === 1
     - track_counts.group === 0
     - scene_count === 3
     - total_clips === 3 (2 from track 0 + 1 from track 1)
     - total_devices === 3 (1 from track 0 + 2 from track 1)
     - device_summary.Wavetable === 1
     - device_summary.Compressor === 1
     - device_summary['EQ Eight'] === 1

4. `describe('session handle()')`:
   - `afterEach(() => { resetClient(); })` for cleanup
   - `it('session_snapshot returns JSON response')` -- setOscClient with sessionMocks(), call handle('session_snapshot', {}), parse JSON, assert track_count === 2
   - `it('session_stats returns JSON response')` -- setOscClient with sessionMocks(), call handle('session_stats', {}), parse JSON, assert track_counts.total === 2
   - `it('returns null for non-session tool names')` -- call handle('device_list', {}), assert result === null

IMPORTANT mock response format notes:
- For is_foldable in buildSessionStats, the direct query `/live/track/get/is_foldable:0` returns [0, 0] (trackId, value). The stats helper uses `resp[1]` for the value. Make sure the mock matches this format.
- For has_midi_input, has_audio_input, num_devices, the existing buildTrackSnapshot uses destructure `[value]` at position 0. The mocks must return [value] format for these (matching existing test patterns).
  </action>
  <verify>
Run `node --test test/session.test.js` from the project root. All tests should pass.
  </verify>
  <done>test/session.test.js exists with passing tests covering: buildTrackDetailSnapshot (routing, grouping, clips, devices, empty slot exclusion), buildSessionSnapshot (full session aggregation), buildSessionStats (type counts, clip counts, device summary), and session handle() (snapshot handler, stats handler, null for non-session names).</done>
</task>

</tasks>

<verification>
1. `node --test test/session.test.js` -- all tests pass
2. `node --test test/device.test.js` -- existing tests still pass (helpers.js changes don't break existing code)
3. `node --test` -- all project tests pass
</verification>

<success_criteria>
- All session tests pass
- Existing device tests still pass (no regression from helpers.js changes)
- Tests verify empty slot detection, track type classification, device chain summary
- Tests verify both tool handlers return valid JSON responses
</success_criteria>

<output>
After completion, create `.planning/phases/07-session-awareness/07-02-SUMMARY.md`
</output>

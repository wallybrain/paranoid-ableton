---
phase: 08-integration-polish
plan: 02
type: execute
wave: 1
depends_on: []
files_modified:
  - src/index.js
autonomous: true

must_haves:
  truths:
    - "Server validates Node.js v20+ before starting MCP transport"
    - "Server validates osc package is importable before starting MCP transport"
    - "Validation failures produce clear error messages on stderr and exit(1)"
    - "No output goes to stdout before MCP transport connects"
    - "Unhandled promise rejections and uncaught exceptions log and exit cleanly"
  artifacts:
    - path: "src/index.js"
      provides: "Startup validation, graceful error handling, structured logging"
      contains: "validateStartup"
  key_links:
    - from: "src/index.js"
      to: "src/logger.js"
      via: "import log for startup messages"
      pattern: "import.*log.*from.*logger"
---

<objective>
Add startup validation and graceful error handling to the MCP server entry point.

Purpose: When the server is misconfigured (wrong Node version, missing packages), it should fail fast with a clear message instead of crashing mid-session with a cryptic error. This is the last thing between the user and a clean first-run experience.

Output: Enhanced index.js with pre-flight validation and process-level error handlers.
</objective>

<execution_context>
@./.claude/agents/gsd-planner.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/phases/08-integration-polish/08-RESEARCH.md
@src/index.js
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add startup validation and process error handlers to index.js</name>
  <files>src/index.js</files>
  <action>
  Rewrite `src/index.js` with startup validation:

  1. Import `log` from `./logger.js` at the top (note: if plan 01 hasn't run yet, logger.js won't exist -- but this plan is wave 1 parallel, so the executor will handle order. If logger.js doesn't exist yet, create a minimal version inline or import conditionally. However, since both plans are wave 1 and index.js only needs logger at runtime not import-time... Actually, if plans run in parallel, we need to handle this. The safest approach: include a check -- if logger.js import fails, fall back to a simple stderr writer. BUT -- looking at the wave system, wave 1 plans execute sequentially within the wave by plan number. So plan 01 runs first, then plan 02. Logger will exist.)

  Import `log` from `./logger.js`.

  2. Add `async function validateStartup()` BEFORE server creation:
     - Check Node.js major version >= 20: `parseInt(process.versions.node.split('.')[0])`. If fails: `log('error', 'Node.js v20+ required', { found: process.versions.node })` then `process.exit(1)`
     - Check osc package importable: `try { await import('osc'); } catch { log('error', 'Package "osc" not found', { fix: 'Run: npm install' }); process.exit(1); }`
     - Check @modelcontextprotocol/sdk importable: same pattern
     - Log info "Startup validation passed" on success

  3. Add process-level error handlers BEFORE main():
     - `process.on('uncaughtException', (err) => { log('error', 'Uncaught exception', { error: err.message, stack: err.stack }); process.exit(1); })`
     - `process.on('unhandledRejection', (reason) => { log('error', 'Unhandled rejection', { reason: String(reason) }); process.exit(1); })`

  4. Update main() function:
     - Call `await validateStartup()` as first line
     - Keep existing server creation and transport setup
     - Replace `console.error('paranoid-ableton MCP server running on stdio')` with `log('info', 'MCP server started', { name: 'paranoid-ableton', version: '0.1.0', transport: 'stdio' })`

  5. Update the catch handler at bottom:
     - Replace `console.error('Fatal error:', err)` with `log('error', 'Fatal startup error', { error: err.message })`

  6. Ensure ZERO console.log() calls in the file (stdout is MCP transport).
  </action>
  <verify>
  `node -c src/index.js` -- syntax check passes.
  `node -e "import('./src/index.js')"` -- should start MCP server (will error on stdin not being a transport, but validates imports work).
  Grep for console.log in src/index.js returns zero matches.
  </verify>
  <done>
  index.js validates Node v20+ and package availability before MCP transport starts.
  Validation failures produce structured JSON error on stderr and exit(1).
  Process-level handlers catch uncaught exceptions and unhandled rejections.
  Zero console.log calls (stdout reserved for MCP).
  </done>
</task>

</tasks>

<verification>
- `node -c src/index.js` passes syntax check
- No `console.log` in src/index.js (grep confirms)
- `node -e "process.versions.node"` confirms Node 20+ for validation pass path
</verification>

<success_criteria>
1. validateStartup() runs before server.connect() and checks Node version + packages
2. Failed validation exits with code 1 and structured error on stderr
3. Process-level error handlers prevent unhandled crashes
4. All logging uses structured JSON via logger.js
5. stdout is clean (no output before MCP transport)
</success_criteria>

<output>
After completion, create `.planning/phases/08-integration-polish/08-02-SUMMARY.md`
</output>

---
phase: 05-sample-indexer
plan: 03
type: execute
wave: 2
depends_on: ["05-01"]
files_modified:
  - test/sample-index.test.js
autonomous: true

must_haves:
  truths:
    - "Classifier correctly identifies instrument types from diverse filename patterns"
    - "Classifier extracts BPM from multiple naming conventions"
    - "Classifier extracts musical key from filename patterns"
    - "Classifier extracts character tags from filenames"
    - "Index store search filters work correctly for all query fields"
    - "Index store handles upsert (update existing entry by path)"
    - "Concurrent scan guard rejects second scan"
  artifacts:
    - path: "test/sample-index.test.js"
      provides: "Unit tests for classifier, index-store, and scanner guard"
      min_lines: 100
  key_links:
    - from: "test/sample-index.test.js"
      to: "src/sample-index/classifier.js"
      via: "import classifyFromPath"
      pattern: "import.*classifyFromPath.*classifier"
    - from: "test/sample-index.test.js"
      to: "src/sample-index/index-store.js"
      via: "import search, addEntry, getStats, clearIndex"
      pattern: "import.*search.*index-store"
---

<objective>
Unit tests for the sample indexer engine: classifier heuristics, index store search, and scanner guards.

Purpose: The classifier heuristics and search logic are the most critical and nuanced parts of Phase 5. Testing ensures diverse filename conventions are handled correctly and search filters compose properly. Uses the established node:test runner pattern.

Output: test/sample-index.test.js with comprehensive tests.
</objective>

<execution_context>
@/home/lwb3/.claude/get-shit-done/workflows/execute-plan.md
@/home/lwb3/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/05-sample-indexer/05-01-SUMMARY.md
@test/osc-client.test.js
@test/mcp-server.test.js
</context>

<tasks>

<task type="auto">
  <name>Task 1: Write classifier unit tests</name>
  <files>test/sample-index.test.js</files>
  <action>
Create `test/sample-index.test.js` using `node:test` and `node:assert` (matching project convention from existing test files).

**Classifier tests (describe 'classifier'):**

Test `classifyFromPath` with these cases:

Instrument type detection:
- `'/samples/Drums/Kicks/kick_01.wav'` -> instrument_type: 'kick'
- `'/samples/BD_808.wav'` -> instrument_type: 'kick' (BD alias)
- `'/samples/snr_tight.wav'` -> instrument_type: 'snare' (snr alias)
- `'/samples/HiHats/OH_01.wav'` -> instrument_type: 'hihat' (OH = open hat)
- `'/samples/CH_closed.wav'` -> instrument_type: 'hihat' (CH = closed hat)
- `'/samples/Synths/lead_bright.wav'` -> instrument_type: 'synth' (folder path)
- `'/samples/FX/riser_01.wav'` -> instrument_type: 'fx' (riser keyword)
- `'/samples/vocal_hook.wav'` -> instrument_type: 'vocal'
- `'/samples/loop_drums_01.wav'` -> instrument_type: 'loop'
- `'/samples/random_noise.wav'` -> instrument_type: null (no match -- "noise" maps to fx actually, so adjust test or verify classifier has it)

BPM extraction:
- `'kick_120bpm.wav'` -> bpm: 120
- `'snare_120_bpm.wav'` -> bpm: 120
- `'loop_bpm128.wav'` -> bpm: 128
- `'hat_140BPM_dry.wav'` -> bpm: 140
- `'bass_90_dark.wav'` -> bpm: 90 (between delimiters, in range 40-300)
- `'kick_01.wav'` -> bpm: null (no BPM info)
- `'sample_999.wav'` -> bpm: null (999 out of range)

Key extraction:
- `'pad_Cmin_warm.wav'` -> key: 'Cmin'
- `'bass_F#maj.wav'` -> key: 'F#maj'
- `'lead_Am.wav'` -> key: 'Amin' (normalize "Am" -> "Amin")
- `'chord_Bbminor.wav'` -> key: 'Bbmin' (normalize "Bbminor" -> "Bbmin")
- `'kick_dry.wav'` -> key: null

Character tags:
- `'kick_punchy_dark.wav'` -> character_tags includes 'punchy' and 'dark'
- `'pad_warm_analog.wav'` -> character_tags includes 'warm' and 'analog'
- `'kick_01.wav'` -> character_tags: [] (empty)

Use `describe` and `it` from node:test. Use `assert.strictEqual` and `assert.deepStrictEqual`.
  </action>
  <verify>`node --test test/sample-index.test.js` -- classifier tests pass.</verify>
  <done>Classifier tests cover instrument type aliases, BPM patterns, key parsing, and character tag extraction across diverse naming conventions.</done>
</task>

<task type="auto">
  <name>Task 2: Write index store and scanner guard tests</name>
  <files>test/sample-index.test.js</files>
  <action>
Append to `test/sample-index.test.js`:

**Index store tests (describe 'index-store'):**

Setup: Call `clearIndex()` in a `beforeEach` to reset state between tests.

Create helper to make sample entries:
```javascript
function makeEntry(overrides = {}) {
  return {
    path: '/test/sample.wav',
    relative_path: 'sample.wav',
    filename: 'sample.wav',
    extension: '.wav',
    duration_ms: 500,
    sample_rate: 44100,
    bit_depth: 16,
    channels: 1,
    codec: 'wav',
    bpm: null,
    key: null,
    instrument_type: null,
    character_tags: [],
    file_size: 44100,
    mtime_ms: 1000,
    scan_root: '/test',
    ...overrides
  };
}
```

Tests:
- **addEntry + getEntryByPath**: Add entry, retrieve by path, verify fields match.
- **upsert**: Add entry, add again with same path but different bpm, verify update took effect.
- **search by instrument_type**: Add 3 entries (kick, snare, kick), search instrument_type='kick', expect 2 results.
- **search by bpm range**: Add entries with bpm 100, 120, 140, null. Search bpm_min=110, bpm_max=130, expect 1 result (120). Null-bpm entries excluded.
- **search by key**: Add entries with key 'Cmin', 'F#maj', null. Search key='Cmin', expect 1 result.
- **search by text**: Add entries with filenames 'kick_hard.wav', 'snare_soft.wav'. Search text='kick', expect 1 result.
- **search by character**: Add entry with character_tags=['punchy','dark'], another with ['warm']. Search character='punchy', expect 1 result.
- **search by format**: Add '.wav' and '.aiff' entries. Search format='wav' (without dot), expect only wav entries.
- **search with limit**: Add 10 entries, search with limit=3, expect 3 results.
- **search combined filters**: Add entries, search with instrument_type='kick' AND bpm_min=100, verify AND logic.
- **getStats**: Add mixed entries, verify total_samples, by_instrument_type, by_format counts.
- **clearIndex**: Add entries, clear, verify getStats shows total_samples=0.

**Scanner guard test (describe 'scanner'):**

Import `getScanStatus` from scanner.js. Test:
- `getScanStatus()` returns `{ scanning: false }` when no scan is running.

(Full scan tests require real audio files on disk -- those are integration tests verified manually via the MCP tools. Unit tests cover the guard and status reporting.)
  </action>
  <verify>`node --test test/sample-index.test.js` -- all tests pass (classifier + index-store + scanner guard).</verify>
  <done>Comprehensive unit tests cover classifier heuristics, index store CRUD/search/stats, and scanner status. All tests pass with node:test runner.</done>
</task>

</tasks>

<verification>
1. `node --test test/sample-index.test.js` passes all tests
2. `npm test` still passes all existing tests (no regressions)
3. Test count is reasonable (20+ individual test cases)
</verification>

<success_criteria>
- test/sample-index.test.js exists with tests for classifier, index-store, and scanner
- Classifier tests verify instrument type aliases, BPM patterns, key parsing, character tags
- Index store tests verify CRUD, search filters, combined queries, stats
- All tests pass with `node --test`
- Existing tests still pass with `npm test`
</success_criteria>

<output>
After completion, create `.planning/phases/05-sample-indexer/05-03-SUMMARY.md`
</output>
